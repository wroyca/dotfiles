{{- $latestRelease := gitHubLatestRelease "nushell/nushell" -}}
{{- if not $latestRelease -}}
{{-   fail "Failed to retrieve Nushell release information from GitHub API" -}}
{{- end -}}

{{- $nushellVersion := $latestRelease.TagName -}}
{{- if not $nushellVersion -}}
{{-   fail "Invalid or missing version tag in GitHub release metadata" -}}
{{- end -}}

{{- $targetArchitecture := .chezmoi.arch -}}
{{- if not $targetArchitecture -}}
{{-   fail "Target architecture specification is undefined or empty" -}}
{{- end -}}

{{- if eq $targetArchitecture "arm64" -}}
{{-   $targetArchitecture = "aarch64" -}}
{{- else if eq $targetArchitecture "x86_64" -}}
{{/* Maintain standard x86_64 designation */}}
{{- else if eq $targetArchitecture "amd64" -}}
{{-   $targetArchitecture = "x86_64" -}}
{{- else -}}
{{-   printf "Unsupported target architecture: %s" $targetArchitecture | fail -}}
{{- end -}}

{{- $operatingSystem := .chezmoi.os -}}
{{- if not $operatingSystem -}}
{{-   fail "Operating system detection failed or returned empty value" -}}
{{- end -}}

{{- if eq $operatingSystem "linux" -}}
{{-   $operatingSystem = "linux-gnu" -}}
{{- else if eq $operatingSystem "darwin" -}}
{{/* Maintain darwin designation for macOS */}}
{{- else if eq $operatingSystem "windows" -}}
{{-   $operatingSystem = "windows-msvc" -}}
{{- else -}}
{{-   printf "Unsupported operating system: %s" $operatingSystem | fail -}}
{{- end -}}

{{- $archiveExtension := "" -}}
{{- if eq $operatingSystem "windows-msvc" -}}
{{-   $archiveExtension = "zip" -}}
{{- else -}}
{{-   $archiveExtension = "tar.gz" -}}
{{- end -}}

{{- $systemVendor := "" -}}
{{- if eq $operatingSystem "linux-gnu" -}}
{{-   $systemVendor = "unknown" -}}
{{- else if eq $operatingSystem "darwin" -}}
{{-   $systemVendor = "apple" -}}
{{- else if eq $operatingSystem "windows-msvc" -}}
{{-   $systemVendor = "pc" -}}
{{- else -}}
{{-   printf "Unsupported operating system for vendor mapping: %s" $operatingSystem | fail -}}
{{- end -}}

{{- $distributionUrl := printf "https://github.com/nushell/nushell/releases/download/%s/nu-%s-%s-%s-%s.%s"
  (toString $nushellVersion)
  (toString $nushellVersion)
  (toString $targetArchitecture)
  (toString $systemVendor)
  (toString $operatingSystem)
  (toString $archiveExtension) -}}

{{/*  Nushell Shell Binary Installation Configuration */}}
{
  ".local/bin": {
    "url": "{{ $distributionUrl }}",
    "type": "archive",
    "refreshPeriod": "24h",
    "executable": true,
    "stripComponents": 1
  }
}
